# Коллектор для https://openweathermap.org/

Ежечасно запрашивает текущую погоду в 50 крупнейших городах мира и сохраняет в БД.  

## Стек

- Python 3.10
- Django 3.2.16
- DRF 3.14.0
- Celery 5.2.7
- Redis 4.3.4

Использован внешний API  и токен автора

## Как работает коллектор
В проекте две задачи:

Первая - однократно загружает из внешних API в БД сведения о 50 городах,
перечень наименований которых с указанием наименований стран
находится в файле cities.csv в папке [/project/data/](./project/data/).

Сервис [openweathermap.org](https://openweathermap.org/) для различения городов
с одинаковыми названиями, в ответах даёт alfa2-код страны-принадлежности города.
Для унификации стандартов хранения данных решено различать города таким же образом, 
но тогда пользователям было бы неудобно добавлять новые города в загрузку.
Пользователям (в т.ч. разработчикам, пополняющим cities.csv вручную)
проще указать к городу полное название страны. А задача, обратившись в API 
[Dadata.ru](https://dadata.ru/api/suggest/country/), по названиям стран
загружает их alfa2-код; затем обратившись в API [openweathermap.org](https://openweathermap.org/),
по названиям городов и alfa2-кодам загружает координаты городов, и сохраняет в БД
все данные, полученные из cities.csv и двух внешних API.
Координаты нужны, потому что в документации [openweathermap.org](https://openweathermap.org/)
в качестве основного способа запросов представлен запрос по координатам lat / lon.
Запрос по названию города и коду страны "спрятан" в дальних текстах документации,
хотя раньше выставлялся как основной. Следуя стратегии внешнего API, текущая погода
запрашивается по координатам.

Вторая задача - ежечасно загружает из API [openweathermap.org](https://openweathermap.org/)
в БД сведения о погоде во всех городах, сохранённых в БД.

Структура БД построена в соответствии со структурой JSON-ответа [openweathermap.org](https://openweathermap.org/)
для удобства реализации сериализации данных.

Данная архитектура проекта и выбранные технологии позволяют:
- регулировать частоту и время загрузки данных,
- приостанавливать и возобновлять отдельные задачи,
- добавлять новые задачи,
- далее можно реализовать удобный способ добавления или удаления городов из загрузки,
- далее в проекте можно построить REST API для интеграции.

## Как запустить проект
Клонировать репозиторий:

```
git clone git@github.com:airatbakiev/weather50.git
```
Перейти в папку проекта и создать файл .env
```
cd project/project
touch ./env
```
Добавить в файл .env следующие переменные:
```
Переменная KEY: <SEСRET_KEY> django-проекта
Переменная APPID: токен сервиса openweathermap.org
Переменная TOKEN: токен сервиса Dadata.ru
Переменная: DB_ENGINE, значение: django.db.backends.postgresql
Переменная: DB_HOST, значение: db
Переменная: DB_NAME, значение: postgres
Переменная: DB_PORT, значение: 5432
Переменная: POSTGRES_USER, значение: postgres
Переменная: POSTGRES_PASSWORD, значение: postgres
```
Перейти в папку infra и запустить docker-compose.yaml
```
cd ../../infra
sudo docker-compose up
```
Миграции моделей, суперпользователь, расписание задач будут созданы автоматически.

Через несколько секунд после запуска будут загружены данные по 50 крупнейшим городам мира.

Ещё через несколько секунд начнётся первая итерация ежечасной загрузки погоды в этих городах.   

Для просмотра загруженных данных перейдите в админку проекта:

[http://127.0.0.1:8000/admin/](http://127.0.0.1:8000/admin/)

## Ближайшие планы по развитию проекта
1. Добавить "ручки" REST API для использования данных.
2. Расширить функционал логирования и просмотра логов,
3. Добавить уведомления в телеграм об ошибках и сбоях.

## Автор

Айрат Бакиев

## Лицензия

[MIT]((./LICENSE))